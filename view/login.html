<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="bullion management site, rare coins, gold, silver, platinum">
    <meta name="author" content="CSE134B Dream Team">
    <title>Log In To Bull's Hit</title>
    <link rel="stylesheet" type="text/css" href="../style/style.css">
    <meta name=viewport content="width=device-width, initial-scale=.8, minimum-scale = .8, user-scalable=yes">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link data-require="purecss@*" data-semver="0.6.0" rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css" />
    <script src="../js/jquery-1.11.2.min.js"></script>
    <script src="../js/velocity.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/cookies.main.js"></script>
</head>

<body>
    <nav>
        Bull's Hit
    </nav>
    <div class="mobile-nav">
        Bull's Hit
    </div>

    <div id="w0-wrapper">
        <form class="pure-form pure-form-stacked reg">
            <fieldset>
                <legend>Log In</legend>
                <label for="username">Username</label>
                <input class="reg" id="username" name="username" type="text" placeholder="Username" required>

                <label for="password">Password</label>
                <input class="reg" id="password" name="password" type="password" placeholder="Password" required>

                <button id="submitButton" type="button" class="pure-button pure-button-primary">Log In</button>

                <div id="alert-box">
                    Please enter your user information.
                </div>
            </fieldset>
        </form>
    </div>
    <script>
	    // Wait till the DOM completely loads before allowing the script to run.
        window.onload = function() {
            document.getElementById("submitButton")
            .addEventListener("click", function() {
	            // APP and API Key for Parse
	            var appId = "iFY8hb8r6Ue1Qh98NBCP1tWshhexxQS1tOsRTk0W";
                var apiKey = "xPKaGBUFnH5vhMN8W77wuuGFoeesi4zbl0H2bLL1";

                // Get the username and password from the DOM
                var username = document.getElementById('username').value;
                var password = document.getElementById('password').value;

                // URL Encode the string so it gets sent properlly
                var encodedString = encodeURI('username=' + username + '&password=' + password);
                console.log(encodedString);

				// Create a request
                var req = new XMLHttpRequest();

				// Request Handler
				req.onreadystatechange = function (oEvent) {
					if (req.readyState === 4) {
						if (req.status === 200) {                 // CASE SUCESS
							// Parse the string into a JSON obj
							var tmpObj = JSON.parse(req.responseText);
							// Cookies wrapper library at 1kb for convenience
							Cookies.set('sessionToken', tmpObj.sessionToken);
							console.log('Session Token: '+ Cookies.get('sessionToken'));
                            window.location.href = "wire2.html";
						} else {                      // CASE ERROR
                            var errorMessage = "";
                            if (username === "")
                                errorMessage = errorMessage + "Username is required!<br>";
                            if (password === "")
                                errorMessage = errorMessage + "Password is required!<br>";

							console.log("Error: ", req.statusText);
                            document.getElementById('alert-box').style.color = "RED";
                            document.getElementById('alert-box').innerHTML = errorMessage;
						}
					}
				};

				// Open the request with the Url Encoded String for login
                req.open("GET", "https://api.parse.com/1/login?" + encodedString, true);

                // Set Request Header for Parse
                req.setRequestHeader("X-Parse-Application-Id", appId);
                req.setRequestHeader("X-Parse-REST-API-Key", apiKey);
                req.send();  // Finally send the request
            });
            
        }
    </script>
    <script>loadFooter();</script>
</body>

</html>
